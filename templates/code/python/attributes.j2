from typing import Final

{%- import 'common.j2' as c %}

{% set attributes = ctx.attributes | list %}
{% set enum_attributes = attributes | select("enum") | rejectattr("name", "in", ctx.excluded_attributes) | list %}
{% if enum_attributes | count > 0 %}from enum import Enum{% endif %}
{{c.import_deprecated(enum_attributes)}}

{%- macro attribute_key(attribute) -%}
{{ attribute.key | screaming_snake_case }}{%- if attribute.type is template_type -%}_TEMPLATE{%- endif -%}
{%- endmacro -%}

{%- macro write_docstring(brief, note, deprecated_note, multiline) -%}
{%- if multiline %}"""
{% endif %}
    {%- if deprecated_note -%}
Deprecated: {{deprecated_note.note | comment(format="python")}}.
    {%- elif brief -%}
{{brief | comment(format="python")}}.
        {%- if note %}
Note: {{note | comment(format="python")}}.
        {%- endif -%}
    {%- endif -%}
{%- if multiline %}
"""{%- endif %}
{%- endmacro -%}

{% for attribute in attributes %}
{% set attr_name = attribute_key(attribute) %}
{%- set multiline = attribute.key not in ctx.excluded_attributes -%}
{%- set deprecated_note = attribute.deprecated if attribute is deprecated %}
{%- set doc_string = write_docstring(attribute.brief, attribute.note, deprecated_note, multiline) -%}
{%- set prefix = "" if multiline else "# " -%}
{{prefix}}{{attr_name}}: Final = "{{attribute.key}}"
{{prefix}}{{doc_string}}
{% endfor %}

{% for attribute in enum_attributes %}{%- set class_name = attribute.key | map_text("py_enum_attribute_to_class_name", attribute.key | pascal_case ~ "Values") -%}
{%- if attribute is deprecated %}
@deprecated("The attribute {{attribute.key}} is deprecated - {{ attribute.deprecated.note | comment(format="python") }}")
    {%- endif %}
class {{class_name}}(Enum):
    {%- for member in attribute.type.members %}
    {% set member_name = member.id | screaming_snake_case -%}
    {%- set doc_string = write_docstring(member.brief or member.id, "", member.deprecated, false) -%}
    {{member_name}} = {{ member.value | print_member_value }}
    {% if doc_string %}"""{{doc_string}}"""{% endif %}
    {%- endfor %}
{% endfor %}